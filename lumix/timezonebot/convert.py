import datetime
import sys

# Tentativo di importare zoneinfo (Python 3.9+) o pytz come fallback
try:
    from zoneinfo import ZoneInfo, available_timezones
    USE_ZONEINFO = True
except ImportError:
    import pytz
    USE_ZONEINFO = False

# Mapping di città comuni a fusi orari IANA
CITY_TIMEZONE = {
    "tokyo": "Asia/Tokyo",
    "roma": "Europe/Rome",
    "rome": "Europe/Rome",
    "london": "Europe/London",
    "newyork": "America/New_York",
    "losangeles": "America/Los_Angeles",
    "chicago": "America/Chicago",
    "paris": "Europe/Paris",
    "berlin": "Europe/Berlin",
    "moscow": "Europe/Moscow",
    "beijing": "Asia/Shanghai",
    "shanghai": "Asia/Shanghai",
    "hongkong": "Asia/Hong_Kong",
    "singapore": "Asia/Singapore",
    "sydney": "Australia/Sydney",
    "auckland": "Pacific/Auckland",
    "dubai": "Asia/Dubai",
    "mumbai": "Asia/Kolkata",
    "delhi": "Asia/Kolkata",
    "kolkata": "Asia/Kolkata",
    "cairo": "Africa/Cairo",
    "johannesburg": "Africa/Johannesburg",
    "rio": "America/Sao_Paulo",
    "saopaulo": "America/Sao_Paulo",
    "mexicocity": "America/Mexico_City",
    "toronto": "America/Toronto",
    "vancouver": "America/Vancouver",
    "denver": "America/Denver",
    "phoenix": "America/Phoenix",
    "lasvegas": "America/Los_Angeles",
    "seattle": "America/Los_Angeles",
    "boston": "America/New_York",
    "washington": "America/New_York",
    "atlanta": "America/New_York",
    "miami": "America/New_York",
    "dallas": "America/Chicago",
    "houston": "America/Chicago",
    "detroit": "America/Detroit",
    "honolulu": "Pacific/Honolulu",
    "anchorage": "America/Anchorage",
    "fairbanks": "America/Anchorage",
    "juneau": "America/Juneau",
    "santafe": "America/Denver",
    "albuquerque": "America/Denver",
    "saltlakecity": "America/Denver",
    "boise": "America/Boise",
    "portland": "America/Los_Angeles",
    "sanfrancisco": "America/Los_Angeles",
    "sanjose": "America/Los_Angeles",
    "sacramento": "America/Los_Angeles",
    "fresno": "America/Los_Angeles",
    "bakersfield": "America/Los_Angeles",
    "sandiego": "America/Los_Angeles",
    "tijuana": "America/Tijuana",
    "vancuver": "America/Vancouver",
    "calgary": "America/Edmonton",
    "edmonton": "America/Edmonton",
    "winnipeg": "America/Winnipeg",
    "regina": "America/Regina",
    "saskatoon": "America/Regina",
    "ottawa": "America/Toronto",
    "montreal": "America/Toronto",
    "quebec": "America/Toronto",
    "halifax": "America/Halifax",
    "stjohns": "America/St_Johns",
    "yellowknife": "America/Yellowknife",
    "inuvik": "America/Inuvik",
    "whitehorse": "America/Whitehorse",
    "dawson": "America/Dawson",
    "cancun": "America/Cancun",
    "merida": "America/Merida",
    "monterrey": "America/Monterrey",
    "guadalajara": "America/Mexico_City",
    "acapulco": "America/Mexico_City",
    "puertovallarta": "America/Mexico_City",
    "mazatlan": "America/Mazatlan",
    "chihuahua": "America/Chihuahua",
    "hermosillo": "America/Hermosillo",
    "liverpool": "Europe/London",
    "manchester": "Europe/London",
    "birmingham": "Europe/London",
    "leeds": "Europe/London",
    "sheffield": "Europe/London",
    "bristol": "Europe/London",
    "newcastle": "Europe/London",
    "glasgow": "Europe/London",
    "edinburgh": "Europe/London",
    "cardiff": "Europe/London",
    "belfast": "Europe/London",
    "dublin": "Europe/Dublin",
    "cork": "Europe/Dublin",
    "lisbon": "Europe/Lisbon",
    "porto": "Europe/Lisbon",
    "madrid": "Europe/Madrid",
    "barcelona": "Europe/Madrid",
    "valencia": "Europe/Madrid",
    "sevilla": "Europe/Madrid",
    "malaga": "Europe/Madrid",
    "bilbao": "Europe/Madrid",
    "zaragoza": "Europe/Madrid",
    "murcia": "Europe/Madrid",
    "palma": "Europe/Madrid",
    "laspalmas": "Atlantic/Canary",
    "santacruz": "Atlantic/Canary",
    "tenerife": "Atlantic/Canary",
    "funchal": "Atlantic/Madeira",
    "pontadelgada": "Atlantic/Azores",
    "azores": "Atlantic/Azores",
    "reykjavik": "Atlantic/Reykjavik",
    "stockholm": "Europe/Stockholm",
    "gothenburg": "Europe/Stockholm",
    "malmo": "Europe/Stockholm",
    "oslo": "Europe/Oslo",
    "bergen": "Europe/Oslo",
    "trondheim": "Europe/Oslo",
    "stavanger": "Europe/Oslo",
    "copenhagen": "Europe/Copenhagen",
    "aarhus": "Europe/Copenhagen",
    "odense": "Europe/Copenhagen",
    "helsinki": "Europe/Helsinki",
    "turku": "Europe/Helsinki",
    "tampere": "Europe/Helsinki",
    "oulu": "Europe/Helsinki",
    "tallinn": "Europe/Tallinn",
    "riga": "Europe/Riga",
    "vilnius": "Europe/Vilnius",
    "warsaw": "Europe/Warsaw",
    "krakow": "Europe/Warsaw",
    "lodz": "Europe/Warsaw",
    "wroclaw": "Europe/Warsaw",
    "poznan": "Europe/Warsaw",
    "gdansk": "Europe/Warsaw",
    "szczecin": "Europe/Warsaw",
    "bydgoszcz": "Europe/Warsaw",
    "lublin": "Europe/Warsaw",
    "katowice": "Europe/Warsaw",
    "czestochowa": "Europe/Warsaw",
    "radom": "Europe/Warsaw",
    "torun": "Europe/Warsaw",
    "kielce": "Europe/Warsaw",
    "opole": "Europe/Warsaw",
    "olsztyn": "Europe/Warsaw",
    "rzeszow": "Europe/Warsaw",
    "gorzow": "Europe/Warsaw",
    "zielonagora": "Europe/Warsaw",
    "prague": "Europe/Prague",
    "brno": "Europe/Prague",
    "ostrava": "Europe/Prague",
    "plzen": "Europe/Prague",
    "liberec": "Europe/Prague",
    "olomouc": "Europe/Prague",
    "ceskebudejovice": "Europe/Prague",
    "hradeckralove": "Europe/Prague",
    "pardubice": "Europe/Prague",
    "usti": "Europe/Prague",
    "zlin": "Europe/Prague",
    "havirov": "Europe/Prague",
    "kladno": "Europe/Prague",
    "most": "Europe/Prague",
    "opava": "Europe/Prague",
    "frydek-mistek": "Europe/Prague",
    "karvina": "Europe/Prague",
    "jihlava": "Europe/Prague",
    "teplice": "Europe/Prague",
    "decins": "Europe/Prague",
    "chomutov": "Europe/Prague",
    "prerov": "Europe/Prague",
    "jablonec": "Europe/Prague",
    "prostejov": "Europe/Prague",
    "trebic": "Europe/Prague",
    "ceskalipa": "Europe/Prague",
    "tabor": "Europe/Prague",
    "znoymo": "Europe/Prague",
    "cheb": "Europe/Prague",
    "trutnov": "Europe/Prague",
    "kolin": "Europe/Prague",
    "pisek": "Europe/Prague",
    "kromeriz": "Europe/Prague",
    "sumperk": "Europe/Prague",
    "vsetin": "Europe/Prague",
    "valasskemezirici": "Europe/Prague",
    "novyjicin": "Europe/Prague",
    "uhradiste": "Europe/Prague",
    "breclav": "Europe/Prague",
    "hodonin": "Europe/Prague",
    "vyskov": "Europe/Prague",
    "bruntal": "Europe/Prague",
    "svitavy": "Europe/Prague",
    "chrudim": "Europe/Prague",
    "benesov": "Europe/Prague",
    "beroun": "Europe/Prague",
    "kladruby": "Europe/Prague",
    "kralupy": "Europe/Prague",
    "neratovice": "Europe/Prague",
    "slany": "Europe/Prague",
    "rakovnik": "Europe/Prague",
    "pribram": "Europe/Prague",
    "dobris": "Europe/Prague",
    "sedlcany": "Europe/Prague",
    "votice": "Europe/Prague",
    "vlasim": "Europe/Prague",
    "pelhrimov": "Europe/Prague",
    "humpolec": "Europe/Prague",
    "paclhov": "Europe/Prague",
    "svetlanad": "Europe/Prague",
    "ledec": "Europe/Prague",
    "habry": "Europe/Prague",
    "chotebor": "Europe/Prague",
    "svetla": "Europe/Prague",
    "pribyslav": "Europe/Prague",
    "bystre": "Europe/Prague",
    "policka": "Europe/Prague",
    "litomysl": "Europe/Prague",
    "ceskatrebova": "Europe/Prague",
    "lanskroun": "Europe/Prague",
    "zamberk": "Europe/Prague",
    "jesenik": "Europe/Prague",
    "bratislava": "Europe/Bratislava",
    "kosice": "Europe/Bratislava",
    "presov": "Europe/Bratislava",
    "zilina": "Europe/Bratislava",
    "banskabystrica": "Europe/Bratislava",
    "nitra": "Europe/Bratislava",
    "trnava": "Europe/Bratislava",
    "trencin": "Europe/Bratislava",
    "martin": "Europe/Bratislava",
    "poprad": "Europe/Bratislava",
    "liptovsky": "Europe/Bratislava",
    "mikulas": "Europe/Bratislava",
    "roznava": "Europe/Bratislava",
    "spisska": "Europe/Bratislava",
    "levoca": "Europe/Bratislava",
    "bardejov": "Europe/Bratislava",
    "stropkov": "Europe/Bratislava",
    "snina": "Europe/Bratislava",
    "humenne": "Europe/Bratislava",
    "michalovce": "Europe/Bratislava",
    "vranov": "Europe/Bratislava",
    "hanusovce": "Europe/Bratislava",
    "sabinov": "Europe/Bratislava",
    "lipany": "Europe/Bratislava",
    "gelnica": "Europe/Bratislava",
    "spisskanovaves": "Europe/Bratislava",
    "levice": "Europe/Bratislava",
    "novezamky": "Europe/Bratislava",
    "komarno": "Europe/Bratislava",
    "dunajskastreda": "Europe/Bratislava",
    "galanta": "Europe/Bratislava",
    "sala": "Europe/Bratislava",
    "senica": "Europe/Bratislava",
    "skalica": "Europe/Bratislava",
    "holic": "Europe/Bratislava",
    "malacky": "Europe/Bratislava",
    "pezinok": "Europe/Bratislava",
    "svatyjur": "Europe/Bratislava",
    "modra": "Europe/Bratislava",
    "brezova": "Europe/Bratislava",
    "mijava": "Europe/Bratislava",
    "stara": "Europe/Bratislava",
    "tura": "Europe/Bratislava",
    "dolnykubin": "Europe/Bratislava",
    "ruzomberok": "Europe/Bratislava",
    "liptovskymikulas": "Europe/Bratislava",
    "kezmarok": "Europe/Bratislava",
    "starysmokovec": "Europe/Bratislava",
    "vysoketatry": "Europe/Bratislava",
    "zdiar": "Europe/Bratislava",
    "tatranskalomnica": "Europe/Bratislava",
    "tatranskastrba": "Europe/Bratislava",
    "strbskepleso": "Europe/Bratislava",
    "sliac": "Europe/Bratislava",
    "banska": "Europe/Bratislava",
    "stiavnica": "Europe/Bratislava",
    "krupina": "Europe/Bratislava",
    "zvolen": "Europe/Bratislava",
    "detva": "Europe/Bratislava",
    "lucenec": "Europe/Bratislava",
    "rimavskasobota": "Europe/Bratislava",
    "kysuckenovemesto": "Europe/Bratislava",
    "cadca": "Europe/Bratislava",
    "namestovo": "Europe/Bratislava",
    "trstena": "Europe/Bratislava",
    "tvrdosin": "Europe/Bratislava",
    "dolnýkubín": "Europe/Bratislava",
    "ružomberok": "Europe/Bratislava",
    "liptovskýhradok": "Europe/Bratislava",
    "liptovskýján": "Europe/Bratislava",
    "liptovskáosada": "Europe/Bratislava",
    "liptovskýtrnovec": "Europe/Bratislava",
    "liptovskýmichal": "Europe/Bratislava",
    "liptovskýondrej": "Europe/Bratislava",
    "liptovskýjuraj": "Europe/Bratislava",
    "liptovskýondrej": "Europe/Bratislava",
    "liptovskýján": "Europe/Bratislava",
    "liptovskáosada": "Europe/Bratislava",
    "liptovskýtrnovec": "Europe/Bratislava",
    "liptovskýmichal": "Europe/Bratislava",
    "liptovskýondrej": "Europe/Bratislava",
    "liptovskýjuraj": "Europe/Bratislava",
}

def get_time_in_city(city: str) -> str:
    """
    Restituisce l'ora corrente nella città specificata.
    """
    city_lower = city.lower().replace(" ", "").replace("-", "")
    if city_lower not in CITY_TIMEZONE:
        raise ValueError(f"Città '{city}' non trovata nel database")

    tz_name = CITY_TIMEZONE[city_lower]
    try:
        if USE_ZONEINFO:
            tz = ZoneInfo(tz_name)
            now = datetime.datetime.now(tz)
        else:
            tz = pytz.timezone(tz_name)
            now = datetime.datetime.now(tz)
        return now.strftime("%Y-%m-%d %H:%M:%S %Z")
    except Exception as e:
        raise RuntimeError(f"Errore nel determinare l'ora per {tz_name}: {e}")

def what_time(city: str) -> str:
    """
    Funzione principale per il comando what-time.
    Restituisce una stringa formattata con l'ora nella città.
    """
    try:
        time_str = get_time_in_city(city)
        return f"Current time in {city.capitalize()}: {time_str}"
    except ValueError as e:
        return str(e)
    except RuntimeError as e:
        return str(e)